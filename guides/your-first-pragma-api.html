---
layout: default
title: Your first Pragma API
description: Learn how to build beautiful RESTful APIs with Pragma.
---

<div class="jumbotron jumbotron-secondary text-center text-lg-left">
  <div class="container">
    <h1 class="display-5 display-lg-4">Your first Pragma API</h1>
    <p class="lead">
      Pragma provides all the components you need to build beautiful, functional RESTful APIs.
      This guide will show you how you can use them to build a simple API for a blog engine.
    </p>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-3 border border-top-0 border-bottom-0 pt-5 pb-4 d-none d-lg-block">
      <ul class="nav flex-column" id="guide-toc">
        <li class="nav-item">
          <a class="nav-link" href="#introduction">Introduction</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#bootstrapping-the-app">Bootstrapping the app</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#creating-resources">Creating resources</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#accepting-input">Accepting input</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#presenting-data">Presenting data</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#restricting-access">Restricting access</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#putting-it-all-together">Putting it all together</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#the-next-steps">The next steps</a>
        </li>
      </ul>
    </div>

    <div class="col-12 col-lg-9 pt-5 pb-4 pl-3 pr-3 pl-lg-5 pr-lg-5 border border-0 border-right-lg-1" data-spy="scroll" data-target="#guide-toc" data-offset="0">
      <h2 class="display-5" id="introduction">Introduction</h2>

      <p>
        Pragma is split into four components:
      </p>

      <ul>
        <li>
          <strong><a href="https://github.com/pragmarb/pragma-operation">Operation</a></strong>:
          operations encapsulate the business logic of your API. Pragma delegates to operations when
          an endpoint of your API is called.
        </li>

        <li>
          <strong><a href="https://github.com/pragmarb/pragma-contract">Contract</a></strong>:
          contracts are like form objects, but for APIs. They also validate incoming GET parameters
          to ensure that the requests are well-formed.
        </li>

        <li>
          <strong><a href="https://github.com/pragmarb/pragma-decorator">Decorator</a></strong>:
          decorators (sometimes also referred to as "representers") take your resources and present
          them to your API's clients in JSON or other formats.
        </li>

        <li>
          <strong><a href="https://github.com/pragmarb/pragma-policy">Policy</a></strong>: policies
          are lightweight Ruby classes that determine which resources a user has access to and what
          operations they can perform on it.
        </li>
      </ul>

      <p>We also provide additional tools:</p>

      <ul>
        <li>
          <strong><a href="https://github.com/pragmarb/pragma-rails">Pragma::Rails</a></strong>
          is our Rails integration. It's a very thin layer taking care of dispatching to operations
          with the right parameters.
        </li>

        <li>
          <strong><a href="https://github.com/pragmarb/pragma-rails-starter">Pragma Rails starter</a></strong>
          is our starter Rails template. It comes with Pragma (obviously!) plus some additional
          tools that will make API development a breeze.
        </li>
      </ul>

      <p>
        In this guide, we'll leverage all of the aforementioned gems and tools to build a simple
        RESTful API for a blog engine with Pragma and Rails.
      </p>

      <h2 class="display-5" id="bootstrapping-the-app">Bootstrapping the app</h2>
      <p>
        First things first. To create a new Rails app with Pragma support, just clone our starter
        repository:
      </p>
      <p>
        <pre><code>$ git clone https://github.com/pragmarb/pragma-rails-starter.git blog</code></pre>
      </p>
      <p>
        This will create a Pragma app ready to go in the <code>blog</code> directory. Just enter the
        directory and take a look at the readme to learn about all the tools it comes with.
      </p>
      <p>
        Since we need our API to persist data, we'll create an <code>Article</code> model which we
        will build an API for:
      </p>
      <pre><code>$ rails g model Article title body:text published:boolean
$ rails db:migrate</code></pre>

      <h2 class="display-5" id="creating-resources">Creating resources</h2>
      <p>
        A Pragma resource is nothing more than data which can be operated on, just like a REST
        resource. On a technical level, each resource will have its own namespace and contain
        operations, decorators, contracts and a policy. All of these are optional, but usually
        you'll want to have all of them.
      </p>
      <p>
        In a Rails Pragma app, your resources will be stored in <code>app/resources</code>. They
        will usually map to a model, but not always. Pragma::Rails also provides a generator for
        creating a new resource, complete with its own system tests. Think of it as <code>rails g scaffold</code>
        for Pragma. Try this:
      </p>
      <pre><code>$ rails g pragma:resource article</code></pre>
      <p>This will generate the following file structure:</p>
      <pre><code>app/resources
└── api
    └── v1
        ├── article
        │   ├── contract
        │   │   ├── base.rb
        │   │   ├── create.rb
        │   │   └── update.rb
        │   ├── decorator
        │   │   ├── collection.rb
        │   │   ├── instance.rb
        │   ├── operation
        │   │   ├── index.rb
        │   │   ├── show.rb
        │   │   ├── create.rb
        │   │   └── update.rb
        │   │   └── destroy.rb
        │   └── policy.rb
spec/requests
└── api
    └── v1
        ├── articles_spec.rb</code></pre>
      <p>It will also edit your <code>config/routes.rb</code> to create CRUD routes for the resource.</p>
      <p>
        You are encouraged to explore the generated files, even though most of them will be
        empty at this point. You have created your first resource which is directly mapped to a
        model, but it doesn't accept any input or present any output yet. It's also publicly
        accessible, meaning everyone will be able to see all articles, even the unpublished ones.
      </p>
      <p>Let's see how we can fix all of that!</p>

      <h2 class="display-5" id="accepting-input">Accepting input</h2>
      <p>
        Let's start with the basics: creating a new article. What we want to do is get the following
        cURL request to work properly:
      </p>
      <pre><code>curl 'https://our-api.example.com/api/v1/articles' \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{
    "title": "Hello, world!",
    "body": "This is my first article. How cool is this?"
  }'</code></pre>
      <p>
        In order to do that, we will edit our resource's <em>contract</em>. A contract is a class
        whose purpose is to validate the input to the resource's API endpoints and persist it to the
        underlying model. Contracts in Pragma are built on top of
        <a href="http://trailblazer.to/gems/reform/">Reform</a>.
      </p>
      <p>
        For our purpose, we will open the <code>API::V1::Article::Contract::Base</code> class and
        edit it like this:
      </p>
      {% highlight ruby %}module API
  module V1
    module Article
      module Contract
        class Base < Pragma::Contract::Base
          property :title, type: coercible(:string)
          property :body, type: coercible(:string)

          validation do
            required(:title).filled
            required(:body).filled(min_length?: 100)
          end
        end
      end
    end
  end
end
{% endhighlight %}
      <p>
        You might not believe it, but that's the only thing you need to do to get that cURL
        request to pass. Try it if you don't believe me!
      </p>
      <p>
        Let's dissect what that code means though. There are two parts to a contract:
      </p>
      <ol>
        <li>
          The contract's <em>properties</em> or attributes, which in turn determine which aspects of
          the resource can be manipulated through the API. You can see that we are also coercing
          both our properties to strings, so that we can safely operate on them.
        </li>
        <li>
          The contract's <em>validations</em>. In our case, we want both the title and the body to
          be filled, and the body to be at least 100 characters in length. If any of these validations
          fail, the article will not be persisted and the API will respond with the 422 Unprocessable
          Entity status code and a list of validation errors.
        </li>
      </ol>
      <p>
        Coercion is provided by <a href="http://dry-rb.org/gems/dry-types/">Dry::Types</a>, while
        validation is provided by <a href="http://dry-rb.org/gems/dry-types/">Dry::Validation</a>.
      </p>
    </div>
  </div>
</div>
